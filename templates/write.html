{% extends 'base.html' %}

{% block content %}
<h2>자산 추가</h2>
<hr width="100%" class="divider"/>
<hr>
<div class="contents">
    <form action="{{ url_for('asset.add_asset') }}" method="POST">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="itamnum">ITAM자산번호:</label>
                    <input type="text" class="form-control" id="itamnum" name="itamnum">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="servername">서버명:</label>
                    <input type="text" class="form-control" id="servername" name="servername" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="ip">IP 주소:</label>
                    <input type="text" class="form-control" id="ip" name="ip" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="hostname">호스트 이름:</label>
                    <input type="text" class="form-control" id="hostname" name="hostname">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="center">센터:</label>
                    <input type="text" class="form-control" id="center" name="center">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="loc1">상면번호:</label>
                    <input type="text" class="form-control" id="loc1" name="loc1">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="loc2">상단번호:</label>
                    <input type="number" class="form-control" id="loc2" name="loc2">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="isvm">VM 여부:</label>
                    <select class="form-control" id="isvm" name="isvm" required>
                        <option value="0">아니오</option>
                        <option value="1">예</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="datein">설치일자:</label>
                    <input type="date" class="form-control" id="datein" name="datein">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="dateout">폐기일자:</label>
                    <input type="date" class="form-control" id="dateout" name="dateout">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="charge">담당자(정):</label>
                    <input type="text" class="form-control" id="charge" name="charge">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="charge2">담당자(부):</label>
                    <input type="text" class="form-control" id="charge2" name="charge2">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="isoper">사용여부:</label>
                    <select class="form-control" id="isoper" name="isoper">
                        {% for option in isoper_options %}
                        <option value="{{ option.state }}">{{ option.state }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="oper">서비스구분:</label>
                    <select class="form-control" id="oper" name="oper">
                        {% for option in oper_options %}
                        <option value="{{ option.state }}">{{ option.state }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="power">전원이중화:</label>
                    <select class="form-control" id="power" name="power">
                        {% for option in power_options %}
                        <option value="{{ option.state }}">{{ option.state }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="pdu">PDU:</label>
                    <input type="text" class="form-control" id="pdu" name="pdu">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="os">OS:</label>
                    <select class="form-control" id="os" name="os">
                        {% for option in os_options %}
                        <option value="{{ option.state }}">{{ option.state }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="osver">OS버전:</label>
                    <input type="text" class="form-control" id="osver" name="osver">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="maker">제조사:</label>
                    <input type="text" class="form-control" id="maker" name="maker">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="model">모델명:</label>
                    <input type="text" class="form-control" id="model" name="model">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="serial">시리얼넘버:</label>
                    <input type="text" class="form-control" id="serial" name="serial">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="domain">도메인:</label>
                    <select class="form-control" id="domain" name="domain">
                        {% for option in domain_options %}
                        <option value="{{ option.state }}">{{ option.state }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="charge3">현업담당자:</label>
                    <input type="text" class="form-control" id="charge3" name="charge3">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="usize">장비크기(U):</label>
                    <input type="number" class="form-control" id="usize" name="usize" min="1" value="1">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="cpucore">물리코어:</label>
                    <input type="number" class="form-control" id="cpucore" name="cpucore" min="1">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="memory">메모리(GB):</label>
                    <input type="number" class="form-control" id="memory" name="memory" min="1">
                </div>
            </div>
        </div>
        <div class="row vm-parent-row" style="display: none;">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="vcenter_display">상위 자산:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="vcenter_display" placeholder="상위 자산을 검색하려면 클릭하세요" readonly>
                        <input type="hidden" id="vcenter" name="vcenter">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="searchParentAsset">검색</button>
                            <button class="btn btn-outline-danger" type="button" id="clearParentAsset">초기화</button>
                        </div>
                    </div>
                    <small class="form-text text-muted">가상 머신인 경우 상위 물리 서버를 선택하세요.</small>
                </div>
            </div>
        </div>
        <div class="text-right">
            <button type="submit" class="btn btn-primary">저장</button>
            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#bulkUploadModal">일괄등록</button>
            <a href="{{ url_for('asset.index') }}" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<!-- 상위 자산 검색 모달 -->
<div class="modal fade" id="parentAssetModal" tabindex="-1" role="dialog" aria-labelledby="parentAssetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="parentAssetModalLabel">상위 자산 검색</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="searchTerm">검색어 (서버명, 호스트명, IP):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchTerm" placeholder="검색어를 입력하세요">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">검색</button>
                        </div>
                    </div>
                </div>
                <div id="searchResults" class="mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>서버명</th>
                                <th>호스트명</th>
                                <th>IP 주소</th>
                                <th>선택</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <!-- 검색 결과가 여기에 표시됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 일괄 등록 모달 -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1" role="dialog" aria-labelledby="bulkUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadModalLabel">자산 일괄 등록</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">양식 다운로드</h6>
                            </div>
                            <div class="card-body">
                                <p>자산 일괄 등록을 위한 엑셀 양식을 다운로드하세요.</p>
                                <a href="{{ url_for('asset.download_template') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-excel"></i> 엑셀 양식 다운로드
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">파일 업로드</h6>
                            </div>
                            <div class="card-body">
                                <form id="bulkUploadForm" action="{{ url_for('asset.bulk_upload') }}" method="POST" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="excelFile">작성된 엑셀 파일 선택:</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="excelFile" name="excelFile" accept=".xlsx" required>
                                            <label class="custom-file-label" for="excelFile">파일 선택...</label>
                                        </div>
                                        <small class="form-text text-muted">
                                            제공된 양식에 맞게 작성된 엑셀 파일(.xlsx)만 업로드 가능합니다.
                                        </small>
                                    </div>
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-upload"></i> 업로드 및 등록
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4" id="uploadResultContainer" style="display: none;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">업로드 결과</h6>
                            </div>
                            <div class="card-body" id="uploadResultContent">
                                <!-- 업로드 결과가 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<style>
    .contents{
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
</style>

<script>
    $(document).ready(function() {
        // VM 여부에 따라 상위 자산 필드 표시/숨김
        $('#isvm').on('change', function() {
            if ($(this).val() === '1') {
                $('.vm-parent-row').show();
            } else {
                $('.vm-parent-row').hide();
                $('#vcenter').val('');
                $('#vcenter_display').val('');
            }
        });

        // 초기 상태 설정
        if ($('#isvm').val() === '1') {
            $('.vm-parent-row').show();
        }

        // 상위 자산 검색 버튼 클릭
        $('#searchParentAsset').on('click', function() {
            $('#parentAssetModal').modal('show');
        });

        // 상위 자산 초기화 버튼 클릭
        $('#clearParentAsset').on('click', function() {
            $('#vcenter').val('');
            $('#vcenter_display').val('');
        });

        // 검색 버튼 클릭
        $('#searchButton').on('click', function() {
            searchParentAssets();
        });

        // 검색어 입력 필드에서 엔터 키 처리
        $('#searchTerm').on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                searchParentAssets();
            }
        });

        // 자산 검색 함수
        function searchParentAssets() {
            var searchTerm = $('#searchTerm').val();
            if (searchTerm.trim() === '') {
                alert('검색어를 입력하세요.');
                return;
            }

            // AJAX 요청으로 자산 검색
            $.ajax({
                url: '/search_assets',
                method: 'GET',
                data: { term: searchTerm },
                success: function(data) {
                    var resultsBody = $('#searchResultsBody');
                    resultsBody.empty();

                    if (data.length === 0) {
                        resultsBody.append('<tr><td colspan="4" class="text-center">검색 결과가 없습니다.</td></tr>');
                    } else {
                        // 검색 결과 표시
                        data.forEach(function(asset) {
                            var row = '<tr>' +
                                      '<td>' + (asset.servername || '') + '</td>' +
                                      '<td>' + (asset.hostname || '') + '</td>' +
                                      '<td>' + (asset.ip || '') + '</td>' +
                                      '<td><button type="button" class="btn btn-sm btn-primary select-asset" ' +
                                      'data-pnum="' + asset.pnum + '" ' +
                                      'data-servername="' + (asset.servername || '') + '" ' +
                                      'data-hostname="' + (asset.hostname || '') + '" ' +
                                      'data-ip="' + (asset.ip || '') + '">선택</button></td>' +
                                      '</tr>';
                            resultsBody.append(row);
                        });
                    }
                },
                error: function() {
                    $('#searchResultsBody').html('<tr><td colspan="4" class="text-center text-danger">검색 중 오류가 발생했습니다.</td></tr>');
                }
            });
        }

        // 자산 선택 버튼 클릭
        $(document).on('click', '.select-asset', function() {
            var pnum = $(this).data('pnum');
            var servername = $(this).data('servername');
            var hostname = $(this).data('hostname');
            var ip = $(this).data('ip');

            // 선택한 자산 정보 설정
            $('#vcenter').val(pnum);
            $('#vcenter_display').val(servername + ' (' + hostname + ', ' + ip + ')');

            // 모달 닫기
            $('#parentAssetModal').modal('hide');
        });

        // 파일 선택 시 파일명 표시
        $('.custom-file-input').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').html(fileName);
        });

        // 일괄 업로드 폼 제출
        $('#bulkUploadForm').on('submit', function(e) {
            e.preventDefault();

            var formData = new FormData(this);

            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function() {
                    $('#uploadResultContainer').hide();
                    $('#uploadResultContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">처리 중...</span></div><p class="mt-2">파일을 처리 중입니다. 잠시만 기다려주세요...</p></div>');
                    $('#uploadResultContainer').show();
                },
                success: function(response) {
                    $('#uploadResultContent').html('');

                    if (response.success) {
                        var resultHtml = '<div class="alert alert-success">' +
                                         '<h5><i class="fas fa-check-circle"></i> 업로드 성공</h5>' +
                                         '<p>' + response.message + '</p>' +
                                         '</div>';

                        if (response.details) {
                            resultHtml += '<div class="table-responsive mt-3">' +
                                          '<table class="table table-sm table-bordered">' +
                                          '<thead><tr><th>항목</th><th>개수</th></tr></thead>' +
                                          '<tbody>';

                            for (var key in response.details) {
                                resultHtml += '<tr><td>' + key + '</td><td>' + response.details[key] + '</td></tr>';
                            }

                            resultHtml += '</tbody></table></div>';
                        }

                        $('#uploadResultContent').html(resultHtml);
                    } else {
                        var errorHtml = '<div class="alert alert-danger">' +
                                        '<h5><i class="fas fa-exclamation-triangle"></i> 업로드 실패</h5>' +
                                        '<p>' + response.message + '</p>' +
                                        '</div>';

                        if (response.errors && response.errors.length > 0) {
                            errorHtml += '<div class="table-responsive mt-3">' +
                                         '<table class="table table-sm table-bordered table-striped">' +
                                         '<thead><tr><th>행</th><th>열</th><th>오류 내용</th></tr></thead>' +
                                         '<tbody>';

                            response.errors.forEach(function(error) {
                                errorHtml += '<tr><td>' + error.row + '</td><td>' + error.column + '</td><td>' + error.message + '</td></tr>';
                            });

                            errorHtml += '</tbody></table></div>';
                        }

                        $('#uploadResultContent').html(errorHtml);
                    }

                    $('#uploadResultContainer').show();
                },
                error: function() {
                    $('#uploadResultContent').html('<div class="alert alert-danger"><h5><i class="fas fa-exclamation-circle"></i> 오류 발생</h5><p>파일 업로드 중 오류가 발생했습니다. 다시 시도해주세요.</p></div>');
                    $('#uploadResultContainer').show();
                }
            });
        });
    });
</script>
{% endblock %}
